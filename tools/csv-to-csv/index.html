<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <meta name="robots" content="index,follow" />

  <title>CSV→CSV 文字コード変換ツール（Shift-JIS / UTF-8 / UTF-8 BOM）無料・ブラウザ完結 | ToolBox</title>
  <meta name="description" content="CSVファイルの文字コードを変換して再ダウンロード。読み込み時/書き出し時の文字コード（Shift-JIS / UTF-8 / UTF-8 BOM）を指定可能。Excelで読めないUTF-8 BOM付きCSVをShift-JISに変換したい場合に便利。無料・ブラウザ完結でサーバー送信なし。" />
  <link rel="canonical" href="https://mat4645.github.io/tools/csv-to-csv/" />

  <style>
    :root{
      --bg:#ffffff; --fg:#111827; --muted:#6b7280; --border:#e5e7eb;
      --shadow: 0 10px 25px rgba(0,0,0,.06);
      --radius:14px; --accent:#2563eb; --danger:#dc2626; --ok:#16a34a;
      --max: 980px;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, "Hiragino Kaku Gothic ProN", "Noto Sans JP", "Yu Gothic", Arial, sans-serif;
      --resultMax: 860px;
    }
    *{box-sizing:border-box}
    body{margin:0; font-family:var(--sans); color:var(--fg); background:linear-gradient(180deg,#fff,#fff 30%, #f7f8fb);}
    a{color:var(--accent); text-decoration:none} a:hover{text-decoration:underline}
    header{position:sticky; top:0; z-index:10; background:rgba(255,255,255,.86); backdrop-filter: blur(8px); border-bottom:1px solid var(--border);}
    .wrap{max-width:var(--max); margin:0 auto; padding:14px 16px}
    .topbar{display:flex; align-items:center; justify-content:space-between; gap:12px}
    .brand{display:flex; align-items:center; gap:10px}
    .logo{width:34px; height:34px; border-radius:10px; background: radial-gradient(circle at 30% 30%, #93c5fd, #2563eb); box-shadow: var(--shadow);}
    .brand strong{font-size:15px}
    .nav{display:flex; gap:12px; flex-wrap:wrap; align-items:center}
    .nav a{font-size:13px; color:var(--muted)} .nav a:hover{color:var(--fg); text-decoration:none}

    main{padding:18px 0 38px}
    h1{margin:0; font-size:26px; letter-spacing:-.02em}
    .sub{color:var(--muted); line-height:1.7; margin:8px 0 0}
    .pill{font-size:12px; color:var(--muted); background:#f3f4f6; border:1px solid var(--border); padding:6px 10px; border-radius:999px; display:inline-block}

    .card{background:var(--bg); border:1px solid var(--border); border-radius:var(--radius); box-shadow: var(--shadow); overflow:hidden; margin-top:14px}
    .hd{padding:12px 14px; border-bottom:1px solid var(--border); background:linear-gradient(180deg,#fff,#fbfbff); display:flex; align-items:center; justify-content:space-between; gap:10px;}
    .hd .t{font-weight:800; font-size:14px}
    .bd{padding:14px}

    .row{display:flex; gap:10px; flex-wrap:wrap; align-items:center}
    .msg{font-size:13px; color:var(--muted); line-height:1.6}
    .ok{color:var(--ok)} .ng{color:var(--danger)}
    .stat{font-size:12px; color:var(--muted)}
    .hint{font-size:12px; color:var(--muted); margin-top:6px}

    select{border:1px solid var(--border); border-radius:10px; padding:8px 10px; background:#fff; font-size:13px}
    input[type="file"]{font-size:13px}

    .btn{border:1px solid var(--border); background:#fff; padding:10px 12px; border-radius:12px; cursor:pointer; font-weight:700; font-size:13px}
    .btn.primary{border-color:#2563eb; background:#2563eb; color:#fff}
    .btn:disabled{opacity:.5; cursor:not-allowed}

    .resultBox{max-width: var(--resultMax); margin-left:auto; margin-right:auto;}
    textarea{
      width:100%;
      height:260px;
      padding:12px;
      border-radius:12px;
      border:1px solid var(--border);
      background:#fff;
      resize:none;
      overflow:auto;
      font-family:var(--mono);
      font-size:13px;
      line-height:1.6;
      outline:none;
      white-space:pre;
    }
    textarea:focus{border-color:#93c5fd; box-shadow: 0 0 0 4px rgba(59,130,246,.12);}

    .step{
      display:flex; gap:10px; align-items:flex-start;
      padding:10px 12px; border:1px solid var(--border); border-radius:12px;
      background:#fff;
    }
    .step + .step{margin-top:10px}
    .num{
      width:26px; height:26px; border-radius:10px;
      background:#eef2ff; color:#3730a3; display:flex; align-items:center; justify-content:center;
      font-weight:900; font-size:13px; flex:0 0 auto;
    }
    .stepBody{flex:1}
    .stepTitle{font-weight:900; font-size:13px; margin:0}
    .stepText{margin:6px 0 0; color:var(--muted); font-size:12px; line-height:1.7}

    .warnBox{
      border:1px solid #fde68a;
      background:#fffbeb;
      color:#92400e;
      border-radius:12px;
      padding:10px 12px;
      font-size:12px;
      line-height:1.7;
      margin-top:10px;
      display:none;
    }

    .badge{
      display:inline-block;
      font-size:11px;
      padding:3px 8px;
      border-radius:999px;
      border:1px solid var(--border);
      background:#f3f4f6;
      color:var(--muted);
      margin-left:6px;
      vertical-align:middle;
    }
    .badge.good{
      background:#ecfdf5;
      border-color:#bbf7d0;
      color:#166534;
    }
    .badge.warn{
      background:#fffbeb;
      border-color:#fde68a;
      color:#92400e;
    }
  </style>

  <!-- Shift-JIS書き出し用（静的サイトで確実に動く） -->
  <script src="https://cdn.jsdelivr.net/npm/encoding-japanese@2.2.0/encoding.min.js"></script>
</head>

<body>
<header>
  <div class="wrap topbar">
    <div class="brand">
      <div class="logo" aria-hidden="true"></div>
      <div>
        <strong>ToolBox</strong><div class="stat">無料・ブラウザ完結ツール集</div>
      </div>
    </div>
    <nav class="nav" aria-label="サイト内リンク">
      <a href="/">ホーム</a>
      <a href="/tools/">ツール一覧</a>
      <a href="/about/">このサイトについて</a>
      <a href="/privacy/">プライバシーポリシー</a>
    </nav>
  </div>
</header>

<main class="wrap">
  <h1>CSV→CSV 文字コード変換</h1>
  <p class="sub">
    CSVファイルを選び、まず<strong>読み込み文字コード</strong>を合わせて内容を確認。
    次に<strong>出力文字コード</strong>を選んでダウンロードします。<br/>
    <span class="pill">サーバー送信なし（ブラウザ内処理）</span>
  </p>

  <section class="card">
    <div class="hd">
      <div class="t">操作手順（1 → 4）</div>
      <div class="stat" id="stat"></div>
    </div>
    <div class="bd">
      <div class="step">
        <div class="num">1</div>
        <div class="stepBody">
          <p class="stepTitle">CSVを選ぶ（ファイル専用）</p>
          <p class="stepText">ファイルを選ぶと自動で読み込みます。</p>
          <label class="msg" style="display:block; margin-top:8px">
            CSVファイル：
            <input type="file" id="fileInput" accept=".csv,text/csv,.txt,text/plain" />
          </label>
          <div class="hint">※ ファイルは送信されません。ブラウザ内で処理します。</div>
        </div>
      </div>

      <div class="step">
        <div class="num">2</div>
        <div class="stepBody">
          <p class="stepTitle">入力（読み込み）文字コードを変えて、プレビューが正しく読めるか確認</p>
          <p class="stepText">文字化けしている場合は「Shift-JIS / UTF-8 / UTF-8(BOM)」を切り替えてください。</p>

          <div class="row" style="margin-top:8px">
            <label class="msg">読み込み文字コード：</label>
            <select id="inEnc" disabled>
              <option value="shift_jis" selected>Shift-JIS</option>
              <option value="utf-8">UTF-8</option>
              <option value="utf-8-bom">UTF-8（BOM付き）</option>
              <option value="utf-16le">UTF-16LE</option>
              <option value="utf-16be">UTF-16BE</option>
            </select>

            <label class="msg" style="margin-left:10px">改行：</label>
            <select id="eol" disabled>
              <option value="crlf" selected>CRLF（Windows）</option>
              <option value="lf">LF</option>
            </select>

            <span class="msg" id="msg"></span>
          </div>

          <div class="warnBox" id="warnBox"></div>
        </div>
      </div>

      <div class="step">
        <div class="num">3</div>
        <div class="stepBody">
          <p class="stepTitle">出力文字コードを選ぶ（Excel向けおすすめを表示）</p>
          <p class="stepText">プレビューが正しく読めたら、出力を選んでください。Excelでの互換性は一般にShift-JISが安定です。</p>

          <div class="row" style="margin-top:8px">
            <label class="msg">出力文字コード：</label>
            <select id="outEnc" disabled>
              <option value="shift_jis" selected>Shift-JIS（Excel向けおすすめ）</option>
              <option value="utf-8">UTF-8</option>
              <option value="utf-8-bom">UTF-8（BOM付き / Excelで安全な場合あり）</option>
            </select>
            <span class="badge good" id="outBadge" style="display:none">おすすめ</span>
            <span class="badge warn" id="warnBadge" style="display:none">注意</span>
          </div>

          <div class="hint" id="outHint" style="margin-top:6px">
            出力をShift-JISにすると、絵文字など一部文字が置換される場合があります。
          </div>
        </div>
      </div>

      <div class="step">
        <div class="num">4</div>
        <div class="stepBody">
          <p class="stepTitle">CSVをダウンロード</p>
          <p class="stepText">設定を変えると自動で再変換されます。最後にダウンロードしてください。</p>

          <div class="row" style="margin-top:8px">
            <button class="btn primary" id="btnDownload" type="button" disabled>変換CSVをダウンロード</button>
            <span class="stat" id="countStat"></span>
          </div>
        </div>
      </div>
    </div>
  </section>

  <section class="card">
    <div class="hd">
      <div class="t">プレビュー（先頭50行）</div>
      <div class="stat" id="previewStat"></div>
    </div>
    <div class="bd">
      <div class="resultBox">
        <textarea id="preview" readonly placeholder="ここにプレビューが表示されます（ファイルを選択してください）"></textarea>
      </div>
      <div class="hint">※プレビューは先頭のみです。全体はダウンロードしたCSVで確認してください。</div>
    </div>
  </section>
</main>

<script>
  const $ = (id) => document.getElementById(id);

  const fileInputEl = $("fileInput");
  const inEncEl = $("inEnc");
  const outEncEl = $("outEnc");
  const eolEl = $("eol");

  const btnDownload = $("btnDownload");
  const msgEl = $("msg");
  const statEl = $("stat");
  const countStatEl = $("countStat");
  const previewStatEl = $("previewStat");
  const previewEl = $("preview");
  const warnBoxEl = $("warnBox");

  const outBadgeEl = $("outBadge");
  const warnBadgeEl = $("warnBadge");
  const outHintEl = $("outHint");

  let lastSelectedFile = null;
  let lastDecodedText = "";
  let lastOutputBytes = null;
  let lastOutputName = "converted.csv";

  function setMsg(text, kind="info"){
    msgEl.textContent = text || "";
    msgEl.className = "msg " + (kind==="ok" ? "ok" : kind==="ng" ? "ng" : "");
  }
  function setStat(text){ statEl.textContent = text || ""; }
  function setCountStat(text){ countStatEl.textContent = text || ""; }
  function setPreviewStat(text){ previewStatEl.textContent = text || ""; }

  function showWarn(text){
    if (!text){
      warnBoxEl.style.display = "none";
      warnBoxEl.textContent = "";
      return;
    }
    warnBoxEl.style.display = "block";
    warnBoxEl.textContent = text;
  }

  function normalizeToLF(s){
    return s.replace(/\r\n/g, "\n").replace(/\r/g, "\n");
  }
  function applyEol(s, eol){
    const lf = normalizeToLF(s);
    return (eol === "crlf") ? lf.replace(/\n/g, "\r\n") : lf;
  }

  function decodeArrayBuffer(buf, encSel){
    const enc = (encSel === "utf-8-bom") ? "utf-8" : encSel;
    let text = "";
    try{
      text = new TextDecoder(enc, { fatal:false }).decode(buf);
    }catch(e){
      text = new TextDecoder("utf-8", { fatal:false }).decode(buf);
    }
    if (text.startsWith("\uFEFF")) text = text.slice(1);
    return text.replace(/\u0000/g, "");
  }

  function encodeToBytes(text, outEnc){
    if (outEnc === "utf-8" || outEnc === "utf-8-bom"){
      const u8 = new TextEncoder().encode(text);
      if (outEnc === "utf-8-bom"){
        const bom = new Uint8Array([0xEF, 0xBB, 0xBF]);
        const merged = new Uint8Array(bom.length + u8.length);
        merged.set(bom, 0);
        merged.set(u8, bom.length);
        return merged;
      }
      return u8;
    }

    if (outEnc === "shift_jis"){
      if (!window.Encoding || !Encoding.stringToCode){
        throw new Error("Shift-JIS書き出し用ライブラリが読み込めませんでした。");
      }
      const unicodeCodes = Encoding.stringToCode(text);
      const sjisCodes = Encoding.convert(unicodeCodes, "SJIS", "UNICODE");
      return new Uint8Array(sjisCodes);
    }

    return new TextEncoder().encode(text);
  }

  function buildOutputName(originalName, outEnc){
    const base = (originalName || "converted").replace(/\.[^.]+$/, "");
    const suffix = (outEnc === "shift_jis") ? "sjis"
                 : (outEnc === "utf-8-bom") ? "utf8bom"
                 : "utf8";
    return `${base}.${suffix}.csv`;
  }

  function makePreview(text){
    const lf = normalizeToLF(text);
    const lines = lf.split("\n");
    const head = lines.slice(0, 50).join("\n");
    const more = lines.length > 50 ? `\n\n...（全${lines.length}行中、先頭50行を表示）` : "";
    return head + more;
  }

  function updateOutputHints(){
    const outEnc = outEncEl.value;

    outBadgeEl.style.display = "none";
    warnBadgeEl.style.display = "none";

    if (outEnc === "shift_jis"){
      outBadgeEl.style.display = "inline-block";
      outHintEl.textContent = "Excelでの互換性が高いのでおすすめです（ただし絵文字など一部文字は置換される場合があります）。";
      warnBadgeEl.style.display = "inline-block";
    } else if (outEnc === "utf-8-bom"){
      outHintEl.textContent = "UTF-8（BOM付き）です。Excelの環境によっては文字化けしにくい場合があります。";
    } else {
      outHintEl.textContent = "UTF-8です。アプリ/システム連携用途でよく使われます。";
    }
  }

  async function reloadAndConvert(){
    if (!lastSelectedFile) return;

    showWarn("");

    try{
      const ab = await lastSelectedFile.arrayBuffer();

      // (2) 入力文字コードで decode
      let text = decodeArrayBuffer(ab, inEncEl.value);

      // 改行を整形（出力もこれに揃える）
      text = applyEol(text, eolEl.value);

      // プレビュー更新
      lastDecodedText = text;
      previewEl.value = makePreview(text);

      const sizeKB = Math.round(lastSelectedFile.size / 1024);
      setStat(`${lastSelectedFile.name}（${sizeKB}KB）`);
      setPreviewStat(`in=${inEncEl.value} / eol=${eolEl.value.toUpperCase()}`);

      // 行数（概算）
      const lineCount = normalizeToLF(text).split("\n").length;

      // (3) 出力文字コードで encode（ダウンロード用に常に作る）
      updateOutputHints();
      const outBytes = encodeToBytes(text, outEncEl.value);

      lastOutputBytes = outBytes;
      lastOutputName = buildOutputName(lastSelectedFile.name, outEncEl.value);

      btnDownload.disabled = false;
      setCountStat(`行数（概算）=${lineCount} / 出力=${lastOutputName}`);

      setMsg("プレビューを確認して、出力を選んでダウンロードしてください。", "ok");

    }catch(e){
      console.error(e);
      lastOutputBytes = null;
      btnDownload.disabled = true;
      previewEl.value = "";
      setCountStat("");
      setPreviewStat("");
      setMsg("変換に失敗しました。読み込み文字コードを変えて再試行してください。", "ng");

      const hint = [
        "原因の例：",
        "・読み込み文字コードが違う（Shift-JIS / UTF-8 / UTF-8 BOMなど）",
        "・ネットワーク制限でShift-JIS書き出しライブラリが読み込めない"
      ].join("\n");
      showWarn(hint);
    }
  }

  // events
  fileInputEl.addEventListener("change", async (e) => {
    const f = e.target.files && e.target.files[0];
    if (!f) return;
    lastSelectedFile = f;

    // enable selects after file picked
    inEncEl.disabled = false;
    outEncEl.disabled = false;
    eolEl.disabled = false;

    updateOutputHints();
    await reloadAndConvert();
  });

  inEncEl.addEventListener("change", reloadAndConvert);
  eolEl.addEventListener("change", reloadAndConvert);

  outEncEl.addEventListener("change", () => {
    updateOutputHints();
    reloadAndConvert();
  });

  btnDownload.addEventListener("click", () => {
    if (!lastOutputBytes) return;

    const blob = new Blob([lastOutputBytes], { type: "text/csv" });
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = lastOutputName;
    document.body.appendChild(a);
    a.click();
    a.remove();
    URL.revokeObjectURL(url);

    setMsg("ダウンロードしました。", "ok");
  });

  // init
  setMsg("CSVファイルを選択してください。");
  updateOutputHints();
</script>
</body>
</html>
