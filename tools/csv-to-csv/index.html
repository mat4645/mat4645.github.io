<!doctype html>
<html lang="ja">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <meta name="robots" content="index,follow" />

  <title>CSV→CSV 文字コード変換ツール（Shift-JIS / UTF-8） | ConvertFileBox</title>
  <meta name="description"
    content="CSVファイルの文字コードを変換して再ダウンロード。読み込み時/書き出し時の文字コード（Shift-JIS / UTF-8 / UTF-8 BOM）を指定可能。Excelで読めないUTF-8 BOM付きCSVをShift-JISに変換したい場合に便利。無料・ブラウザ完結でサーバー送信なし。" />
  <link rel="canonical" href="https://www.convertfilebox.net/tools/csv-to-csv/" />

  <!-- Styles -->
  <link rel="stylesheet" href="/assets/css/style.css">

  <!-- Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700;800&display=swap" rel="stylesheet">

  <!-- Shift-JIS support -->
  <script src="https://cdn.jsdelivr.net/npm/encoding-japanese@2.2.0/encoding.min.js"></script>

  <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-2739559953649909"
    crossorigin="anonymous"></script>
  <!-- Google tag (gtag.js) -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-2M7JXDP7J8"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag() { dataLayer.push(arguments); }
    gtag('js', new Date());

    gtag('config', 'G-2M7JXDP7J8');
  </script>

  <style>
    .form-select {
      width: 100%;
      padding: 0.5rem;
      border: 1px solid var(--border);
      border-radius: var(--radius-sm);
      font-size: 0.9375rem;
      background-color: white;
    }

    .split-pane {
      display: grid;
      grid-template-columns: 1fr;
      gap: 1.5rem;
    }

    @media (min-width: 960px) {
      .split-pane {
        grid-template-columns: 1fr 1fr;
      }
    }
  </style>
</head>

<body>

  <header class="site-header">
    <div class="container flex items-center justify-between" style="height: 100%;">
      <a href="/" class="brand">
        <div class="brand-logo" aria-hidden="true">
          <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none"
            stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z" />
            <polyline points="14 2 14 8 20 8" />
            <path d="M8 13h8" />
            <path d="M8 17h8" />
            <path d="M10 9h4" />
          </svg>
        </div>
        <div>
          ConvertFileBox
          <span class="text-xs text-muted" style="display:block; font-weight:400; line-height:1;">無料ツール集</span>
        </div>
      </a>

      <button id="mobile-menu-btn" class="mobile-menu-btn" aria-label="メニューを開く">
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
          stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <line x1="3" y1="12" x2="21" y2="12"></line>
          <line x1="3" y1="6" x2="21" y2="6"></line>
          <line x1="3" y1="18" x2="21" y2="18"></line>
        </svg>
      </button>

      <nav id="nav-links" class="nav-links">
        <a href="/" class="nav-link">ホーム</a>
        <a href="/tools/" class="nav-link active">ツール一覧</a>
        <a href="/about/" class="nav-link">このサイトについて</a>
      </nav>
    </div>
  </header>

  <main class="container mt-8 mb-8" style="max-width: 1280px;">
    <div class="text-center mb-8">
      <h1>CSV 文字コード変換</h1>
      <p class="text-muted mt-2">
        CSVファイルの文字コード（Shift-JIS / UTF-8 等）を変換して再ダウンロード。<br>
        Excelで文字化けする場合の修正などに便利です。
      </p>
      <div class="flex justify-center gap-4 mt-4">
        <span class="tag">サーバー送信なし</span>
      </div>
    </div>

    <!-- Security Block -->
    <div class="panel mb-8">
      <h2 class="text-lg font-bold mb-4">🔒 セキュリティについて</h2>
      <p class="mb-4 font-bold">入力データはサーバーに送信されません。処理はすべてブラウザ内で完結します。</p>
      <ul class="list-disc list-inside text-sm text-muted mb-6 pl-4">
        <li>ファイルはアップロードされません（外部サーバーへ送信しません）</li>
        <li>入力内容はサーバー側で保存・解析しません</li>
        <li>会社・業務用のCSV/JSONでも安心してご利用いただけます</li>
      </ul>
      <div class="flex flex-wrap gap-2">
        <span class="tag">サーバー送信なし</span>
        <span class="tag">ブラウザ内で完結</span>
        <span class="tag">ログ保存なし</span>
        <span class="tag">インストール不要</span>
      </div>
    </div>

    <label class="file-drop-area" id="dropArea">
      <input type="file" id="fileInput" class="file-input" accept=".csv,text/csv,.txt,text/plain" />
      <div style="font-size: 2rem; color: var(--text-light); margin-bottom: 0.5rem;">📂</div>
      <p class="font-bold text-main">ファイルを選択 または ドラッグ&ドロップ</p>
      <p class="text-sm text-muted mt-2">.csv, .txt</p>
      <div id="fileInfo" class="alert alert-info inline-flex items-center gap-2 mt-4"
        style="display:none; text-align:left; margin-left:auto; margin-right:auto;">
        <span id="fileName"></span> <span class="text-xs opacity-75" id="fileSize"></span>
      </div>
    </label>

    <div class="panel mb-6">
      <div class="flex flex-wrap items-end gap-6">
        <div style="min-width: 150px;">
          <label class="text-xs font-bold text-muted mb-1 block">1. 読み込み文字コード</label>
          <select id="inEnc" class="form-select" disabled>
            <option value="shift_jis" selected>Shift-JIS</option>
            <option value="utf-8">UTF-8</option>
            <option value="utf-8-bom">UTF-8（BOM付き）</option>
            <option value="utf-16le">UTF-16LE</option>
            <option value="utf-16be">UTF-16BE</option>
          </select>
        </div>

        <div style="min-width: 150px;">
          <label class="text-xs font-bold text-muted mb-1 block">2. 出力文字コード</label>
          <select id="outEnc" class="form-select" disabled>
            <option value="shift_jis" selected>Shift-JIS (Excel推奨)</option>
            <option value="utf-8">UTF-8</option>
            <option value="utf-8-bom">UTF-8（BOM付き）</option>
          </select>
        </div>

        <div style="min-width: 120px;">
          <label class="text-xs font-bold text-muted mb-1 block">出力改行コード</label>
          <select id="eol" class="form-select" disabled>
            <option value="crlf" selected>CRLF (Windows)</option>
            <option value="lf">LF (Unix/Mac)</option>
          </select>
        </div>

        <div style="margin-left: auto;">
          <button class="btn btn-primary" id="btnDownload" disabled>変換してダウンロード</button>
        </div>
      </div>
      <div id="warnBadge" class="alert alert-warning mt-4 text-xs" style="display:none"></div>
    </div>

    <div class="split-pane">
      <!-- Preview Input -->
      <div class="flex flex-col gap-2">
        <div class="flex justify-between items-center">
          <h2 class="text-lg font-bold">入力プレビュー (decode結果)</h2>
          <span id="inPreviewStat" class="text-xs text-muted"></span>
        </div>
        <textarea id="previewIn" class="code-editor" readonly style="height: 300px;"
          placeholder="ここに内容が表示されます"></textarea>
      </div>

      <!-- Preview Output -->
      <div class="flex flex-col gap-2">
        <div class="flex justify-between items-center">
          <h2 class="text-lg font-bold">出力プレビュー</h2>
          <span id="outPreviewStat" class="text-xs text-muted"></span>
        </div>
        <textarea id="previewOut" class="code-editor" readonly style="height: 300px;"
          placeholder="変換後のイメージが表示されます"></textarea>
      </div>
    </div>

    <div class="flex justify-center mt-4 text-xs text-muted">
      ※プレビューは先頭50行のみ表示されます。
    </div>

  </main>

  <footer class="site-footer">
    <div class="container text-center">
      <div class="flex justify-center gap-4 mb-4 text-sm text-muted">
        <a href="/tools/">ツール一覧</a>
        <a href="/about/">このサイトについて</a>
        <a href="/privacy/">プライバシーポリシー</a>
      </div>
      <div class="text-xs text-muted">
        &copy; <span id="year">2026</span> ConvertFileBox. <br>
        変換結果の正確性は保証しません（自己責任でご利用ください）。
      </div>
    </div>
  </footer>

  <script src="/assets/js/ui.js"></script>
  <script>
    const $ = (id) => document.getElementById(id);

    const fileInputEl = $("fileInput");
    const dropArea = $("dropArea");
    const fileInfoEl = $("fileInfo");
    const fileNameEl = $("fileName");
    const fileSizeEl = $("fileSize");

    const inEncEl = $("inEnc");
    const outEncEl = $("outEnc");
    const eolEl = $("eol");

    const btnDownload = $("btnDownload");

    const previewInEl = $("previewIn");
    const previewOutEl = $("previewOut");
    const inPreviewStatEl = $("inPreviewStat");
    const outPreviewStatEl = $("outPreviewStat");
    const warnBadgeEl = $("warnBadge");

    let lastSelectedFile = null;
    let lastOutputBytes = null;
    let lastOutputName = "converted.csv";

    function showWarn(text) {
      if (!text) {
        warnBadgeEl.style.display = "none";
        warnBadgeEl.textContent = "";
        return;
      }
      warnBadgeEl.style.display = "block";
      warnBadgeEl.textContent = text;
    }

    function normalizeToLF(s) {
      return s.replace(/\r\n/g, "\n").replace(/\r/g, "\n");
    }
    function applyEol(s, eol) {
      const lf = normalizeToLF(s);
      return (eol === "crlf") ? lf.replace(/\n/g, "\r\n") : lf;
    }

    function decodeArrayBuffer(buf, encSel) {
      const enc = (encSel === "utf-8-bom") ? "utf-8" : encSel;
      let text = "";
      try {
        text = new TextDecoder(enc, { fatal: false }).decode(buf);
      } catch (e) {
        text = new TextDecoder("utf-8", { fatal: false }).decode(buf);
      }
      if (text.startsWith("\uFEFF")) text = text.slice(1);
      return text.replace(/\u0000/g, "");
    }

    function encodeToBytes(text, outEnc) {
      if (outEnc === "utf-8" || outEnc === "utf-8-bom") {
        const u8 = new TextEncoder().encode(text);
        if (outEnc === "utf-8-bom") {
          const bom = new Uint8Array([0xEF, 0xBB, 0xBF]);
          const merged = new Uint8Array(bom.length + u8.length);
          merged.set(bom, 0);
          merged.set(u8, bom.length);
          return merged;
        }
        return u8;
      }

      if (outEnc === "shift_jis") {
        if (!window.Encoding || !Encoding.stringToCode) {
          throw new Error("Shift-JIS書き出し用ライブラリが読み込めませんでした。");
        }
        const unicodeCodes = Encoding.stringToCode(text);
        const sjisCodes = Encoding.convert(unicodeCodes, "SJIS", "UNICODE");
        return new Uint8Array(sjisCodes);
      }

      return new TextEncoder().encode(text);
    }

    function decodeBytes(bytes, enc) {
      if (enc === "shift_jis") {
        if (!window.Encoding || !Encoding.convert || !Encoding.codeToString) {
          return "（Shift-JISプレビュー用ライブラリがありません）";
        }
        const codes = Array.from(bytes);
        const unicodeCodes = Encoding.convert(codes, "UNICODE", "SJIS");
        return Encoding.codeToString(unicodeCodes);
      }
      let t = new TextDecoder("utf-8", { fatal: false }).decode(bytes);
      if (t.startsWith("\uFEFF")) t = t.slice(1);
      return t.replace(/\u0000/g, "");
    }

    function makePreview(text) {
      const lf = normalizeToLF(text);
      const lines = lf.split("\n");
      const head = lines.slice(0, 50).join("\n");
      const more = lines.length > 50 ? `\n\n...（全${lines.length}行中、先頭50行を表示）` : "";
      return head + more;
    }

    function buildOutputName(originalName, outEnc) {
      const base = (originalName || "converted").replace(/\.[^.]+$/, "");
      const suffix = (outEnc === "shift_jis") ? "sjis"
        : (outEnc === "utf-8-bom") ? "utf8bom"
          : "utf8";
      return `${base}.${suffix}.csv`;
    }

    async function reloadAndConvert() {
      if (!lastSelectedFile) return;

      // File Info update
      fileInfoEl.style.display = "inline-flex";
      fileNameEl.textContent = lastSelectedFile.name;
      const sizeKB = Math.round(lastSelectedFile.size / 1024);
      fileSizeEl.textContent = `(${sizeKB}KB)`;

      showWarn("");

      try {
        const ab = await lastSelectedFile.arrayBuffer();

        // 1) 入力文字コードで decode
        const inText = decodeArrayBuffer(ab, inEncEl.value);

        // 入力プレビュー
        previewInEl.value = makePreview(inText);
        inPreviewStatEl.textContent = `読込: ${inEncEl.options[inEncEl.selectedIndex].text}`;

        // 2) 出力用変換
        const outText = applyEol(inText, eolEl.value);
        const outBytes = encodeToBytes(outText, outEncEl.value);

        // 出力プレビュー
        const outTextForPreview = decodeBytes(outBytes, outEncEl.value);
        previewOutEl.value = makePreview(outTextForPreview);
        outPreviewStatEl.textContent = `出力: ${outEncEl.options[outEncEl.selectedIndex].text}`;

        // 警告チェック
        if (outEncEl.value === "shift_jis" && outTextForPreview !== outText) {
          showWarn("注意: Shift-JISで表現できない文字（絵文字など）が含まれています。それらの文字は置換または削除される可能性があります。");
        }

        lastOutputBytes = outBytes;
        lastOutputName = buildOutputName(lastSelectedFile.name, outEncEl.value);

        btnDownload.disabled = false;

      } catch (e) {
        console.error(e);
        lastOutputBytes = null;
        btnDownload.disabled = true;
        previewInEl.value = "エラーが発生しました";
        previewOutEl.value = "";
        showWarn("変換に失敗しました。ライブラリの読み込み状況などを確認してください。");
      }
    }

    // Drag & Drop
    ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
      dropArea.addEventListener(eventName, preventDefaults, false);
    });
    function preventDefaults(e) { e.preventDefault(); e.stopPropagation(); }
    ['dragenter', 'dragover'].forEach(eventName => {
      dropArea.addEventListener(eventName, () => dropArea.classList.add('dragover'), false);
    });
    ['dragleave', 'drop'].forEach(eventName => {
      dropArea.addEventListener(eventName, () => dropArea.classList.remove('dragover'), false);
    });

    dropArea.addEventListener('drop', (e) => {
      const dt = e.dataTransfer;
      const files = dt.files;
      if (files && files[0]) {
        fileInputEl.files = files;
        handleFile(files[0]);
      }
    });

    fileInputEl.addEventListener("change", async (e) => {
      const f = e.target.files && e.target.files[0];
      if (f) handleFile(f);
    });

    function handleFile(f) {
      lastSelectedFile = f;
      inEncEl.disabled = false;
      outEncEl.disabled = false;
      eolEl.disabled = false;
      reloadAndConvert();
    }

    inEncEl.addEventListener("change", reloadAndConvert);
    eolEl.addEventListener("change", reloadAndConvert);
    outEncEl.addEventListener("change", reloadAndConvert);

    btnDownload.addEventListener("click", () => {
      if (!lastOutputBytes) return;
      const blob = new Blob([lastOutputBytes], { type: "text/csv" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = lastOutputName;
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
    });
  </script>
</body>

</html>